name: PR Release Preview

on:
  pull_request:
    branches: [master, main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write
  statuses: write

jobs:
  preview-release:
    runs-on: ubuntu-latest
    if: github.head_ref == 'develop' || contains(github.head_ref, 'release/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # ‚Üê Cambiado de 18 a 20

      - name: Check release relevance
        id: release_relevance
        uses: ./.github/actions/check-release-relevance
        with:
          base-ref: 'origin/master'
          head-ref: 'HEAD'

      - name: Install dependencies
        if: steps.release_relevance.outputs.should-release == 'true'
        run: |
          echo "üì¶ Installing dependencies..."
          npm ci

      - name: Run build and tests
        if: steps.release_relevance.outputs.should-release == 'true'
        id: build_test
        run: |
          echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
          echo "LINT_SUCCESS=false" >> $GITHUB_OUTPUT
          
          echo "üîç Running linting..."
          if npm run lint; then
            echo "‚úÖ Linting passed"
            echo "LINT_SUCCESS=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Linting failed"
            exit 1
          fi
          
          echo "üèóÔ∏è  Running build..."
          if npm run build; then
            echo "‚úÖ Build successful"
            echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Build failed"
            exit 1
          fi

      - name: Analyze release impact
        if: steps.release_relevance.outputs.should-release == 'true'
        id: release_analysis
        run: |
          echo "üîç Analyzing changes for release preview..."
          
          # Get current version
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"
          
          # Find last tag on master
          git fetch origin master
          LAST_TAG=$(git describe --tags --abbrev=0 origin/master 2>/dev/null || echo "")
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
          
          if [ -z "$LAST_TAG" ]; then
            echo "‚ö†Ô∏è  No previous tags found on master"
            echo "This will be the initial release"
            VERSION_TYPE="patch"
            NEW_VERSION="0.1.0"
          else
            echo "üìç Last tag on master: $LAST_TAG"
          
            # Get commits that would be included in the release
            echo "üìã Getting commits since last tag..."
            COMMITS=$(git log $LAST_TAG..HEAD --oneline --no-merges)
            echo "Commits to be included:"
            echo "$COMMITS"
          
            # Store commits for later use
            echo "commits<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          
            # Determine version increment
            if echo "$COMMITS" | grep -qE "^[a-f0-9]+ (feat|feature)(\(.+\))?!:"; then
              VERSION_TYPE="major"
              echo "üö® Found breaking feature - will trigger MAJOR version"
            elif echo "$COMMITS" | grep -qE "^[a-f0-9]+ .+!:"; then
              VERSION_TYPE="major"
              echo "üö® Found breaking change - will trigger MAJOR version"
            elif echo "$COMMITS" | grep -qE "^[a-f0-9]+ (feat|feature)(\(.+\))?:"; then
              VERSION_TYPE="minor"
              echo "üÜï Found feature - will trigger MINOR version"
            else
              VERSION_TYPE="patch"
              echo "üîß Only fixes/chores found - will trigger PATCH version"
            fi
          
            # Calculate new version
            IFS='.' read -ra VERSION_PARTS <<< "${CURRENT_VERSION}"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            PATCH=${VERSION_PARTS[2]}
          
            case $VERSION_TYPE in
              major)
                NEW_VERSION="$((MAJOR + 1)).0.0"
                ;;
              minor)
                NEW_VERSION="${MAJOR}.$((MINOR + 1)).0"
                ;;
              patch)
                NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
                ;;
            esac
          fi
          
          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "üìà Predicted new version: $NEW_VERSION ($VERSION_TYPE increment)"

      - name: Check for potential issues
        if: steps.release_relevance.outputs.should-release == 'true'
        id: issue_check
        run: |
          echo "üîç Checking for potential issues..."
          
          ISSUES=""
          
          # Check if package.json version differs from what would be generated
          CURRENT_VERSION="${{ steps.release_analysis.outputs.current_version }}"
          PREDICTED_VERSION="${{ steps.release_analysis.outputs.new_version }}"
          
          # Check build output
          if [ ! -d "dist" ]; then
            ISSUES="${ISSUES}- ‚ùå dist directory not found after build\n"
          fi
          
          if [ ! -f "dist/late/Late.node.js" ]; then
            ISSUES="${ISSUES}- ‚ùå Late.node.js not found in dist/late/\n"
          fi
          
          # Check critical files
          if [ ! -f "package.json" ]; then
            ISSUES="${ISSUES}- ‚ùå package.json missing\n"
          fi
          
          # Check for uncommitted changes that might affect release
          if git diff --quiet; then
            echo "‚úÖ No uncommitted changes"
          else
            ISSUES="${ISSUES}- ‚ö†Ô∏è  Uncommitted changes detected\n"
          fi
          
          # Store issues
          if [ -n "$ISSUES" ]; then
            echo "issues<<EOF" >> $GITHUB_OUTPUT
            echo -e "$ISSUES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No issues detected"
          fi

      - name: Generate changelog preview
        if: steps.release_relevance.outputs.should-release == 'true'
        id: changelog_preview
        run: |
          echo "üìù Generating changelog preview..."
          
          COMMITS="${{ steps.release_analysis.outputs.commits }}"
          NEW_VERSION="${{ steps.release_analysis.outputs.new_version }}"
          TODAY=$(date +"%Y-%m-%d")
          
          # Generate changelog content
          CHANGELOG_CONTENT="## [${NEW_VERSION}] - ${TODAY}

          ### Changes"
          
          if [ -n "$COMMITS" ]; then
            echo "$COMMITS" | while IFS= read -r commit; do
              if [ -n "$commit" ]; then
                CHANGELOG_CONTENT="${CHANGELOG_CONTENT}
          - ${commit#* }" # Remove commit hash
              fi
            done
          else
            CHANGELOG_CONTENT="${CHANGELOG_CONTENT}
          - Initial release"
          fi
          
          # Store for use in comment
          echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check NPM package status
        if: steps.release_relevance.outputs.should-release == 'true'
        id: npm_check
        run: |
          echo "üì¶ Checking NPM package status..."
          
          PREDICTED_VERSION="${{ steps.release_analysis.outputs.new_version }}"
          
          # Check if version already exists on NPM
          if npm view n8n-nodes-late@$PREDICTED_VERSION version >/dev/null 2>&1; then
            echo "‚ùå Version $PREDICTED_VERSION already exists on NPM!"
            echo "version_exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Version $PREDICTED_VERSION is available on NPM"
            echo "version_exists=false" >> $GITHUB_OUTPUT
          fi
          
          # Get latest NPM version
          LATEST_NPM=$(npm view n8n-nodes-late version 2>/dev/null || echo "not-published")
          echo "latest_npm_version=$LATEST_NPM" >> $GITHUB_OUTPUT
          echo "üìç Latest NPM version: $LATEST_NPM"

      - name: Create PR comment
        uses: actions/github-script@v7
        continue-on-error: true
        id: create_comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Release relevance info
            const shouldRelease = '${{ steps.release_relevance.outputs.should-release }}' === 'true';
            const changeSummary = '${{ steps.release_relevance.outputs.change-summary }}';
            const relevantFiles = '${{ steps.release_relevance.outputs.relevant-files }}';
            const ignoredFiles = '${{ steps.release_relevance.outputs.ignored-files }}';
            
            let status = '‚è≠Ô∏è';
            let recommendation = '‚è≠Ô∏è **SAFE TO MERGE** - Only documentation/config changes, no release will be triggered.';
            
            if (shouldRelease) {
              const buildSuccess = '${{ steps.build_test.outputs.BUILD_SUCCESS }}' === 'true';
              const lintSuccess = '${{ steps.build_test.outputs.LINT_SUCCESS }}' === 'true';
              const hasIssues = '${{ steps.issue_check.outputs.has_issues }}' === 'true';
              const versionExists = '${{ steps.npm_check.outputs.version_exists }}' === 'true';
              
              const currentVersion = '${{ steps.release_analysis.outputs.current_version }}';
              const newVersion = '${{ steps.release_analysis.outputs.new_version }}';
              const versionType = '${{ steps.release_analysis.outputs.version_type }}';
              const lastTag = '${{ steps.release_analysis.outputs.last_tag }}';
              const latestNpm = '${{ steps.npm_check.outputs.latest_npm_version }}';
              const changelogContent = `${{ steps.changelog_preview.outputs.changelog_content }}`;
              const issues = `${{ steps.issue_check.outputs.issues }}`;
              
              status = '‚úÖ';
              if (!buildSuccess || !lintSuccess || hasIssues || versionExists) {
                status = '‚ùå';
              }
              
              if (!buildSuccess || !lintSuccess) {
                recommendation = '‚ùå **DO NOT MERGE** - Build or linting failures need to be fixed first.';
              } else if (versionExists) {
                recommendation = '‚ö†Ô∏è **INVESTIGATE FIRST** - Version conflict needs to be resolved.';
              } else if (hasIssues) {
                recommendation = '‚ö†Ô∏è **REVIEW REQUIRED** - Please address the issues above.';
              } else {
                recommendation = '‚úÖ **READY TO MERGE** - All checks passed, release will be created!';
              }
            }
            
            let comment = '';
            
            if (shouldRelease) {
              const buildSuccess = '${{ steps.build_test.outputs.BUILD_SUCCESS }}' === 'true';
              const lintSuccess = '${{ steps.build_test.outputs.LINT_SUCCESS }}' === 'true';
              const hasIssues = '${{ steps.issue_check.outputs.has_issues }}' === 'true';
              const versionExists = '${{ steps.npm_check.outputs.version_exists }}' === 'true';
              
              const currentVersion = '${{ steps.release_analysis.outputs.current_version }}';
              const newVersion = '${{ steps.release_analysis.outputs.new_version }}';
              const versionType = '${{ steps.release_analysis.outputs.version_type }}';
              const lastTag = '${{ steps.release_analysis.outputs.last_tag }}';
              const latestNpm = '${{ steps.npm_check.outputs.latest_npm_version }}';
              const changelogContent = `${{ steps.changelog_preview.outputs.changelog_content }}`;
              const issues = `${{ steps.issue_check.outputs.issues }}`;
              
              const warningSection = versionExists ? `### ‚ö†Ô∏è **WARNING**
              Version \`${newVersion}\` already exists on NPM! The release will fail.
              You may need to manually increment the version or check why this version already exists.
              ` : '';
              
              const issuesSection = hasIssues ? `### ‚ö†Ô∏è Potential Issues Detected
              ${issues}` : '### ‚úÖ No Issues Detected';
              
              comment = `## ${status} Release Preview for PR #${context.issue.number}
            
              ### üìä Build & Test Status
              - **Linting:** ${lintSuccess ? '‚úÖ Passed' : '‚ùå Failed'}
              - **Build:** ${buildSuccess ? '‚úÖ Successful' : '‚ùå Failed'}
              
              ### üìà Version Analysis
              - **Current Version:** \`${currentVersion}\`
              - **Predicted New Version:** \`${newVersion}\` (${versionType.toUpperCase()} increment)
              - **Last Tag on Master:** ${lastTag || 'None (initial release)'}
              - **Latest NPM Version:** \`${latestNpm}\`
              
              ### üöÄ What Will Happen When Merged
              1. **Auto-release workflow** will trigger (path filters matched)
              2. Version will be bumped to \`${newVersion}\`
              3. Git tag \`v${newVersion}\` will be created
              4. GitHub release will be published
              5. Package will be published to NPM
              
              **Files triggering release:**
              ${relevantFiles.split(',').filter(f => f.trim()).map(f => `- \`${f.trim()}\``).join('\n')}
              
              ${warningSection}
              
              ${issuesSection}
              
              ### üìù Changelog Preview
              \`\`\`markdown
              ${changelogContent}
              \`\`\`
              
              ### üéØ Recommendation
              ${recommendation}`;
            } else {
              comment = `## ${status} Release Preview for PR #${context.issue.number}
              
              ### üìÇ Release Relevance Analysis
              **${changeSummary}**
              
              ### ‚è≠Ô∏è No Release Will Be Triggered
              Only documentation/configuration files were changed, so no release will be created when merged.
              
              **Changed files (ignored):**
              ${ignoredFiles.split(',').filter(f => f.trim()).map(f => `- \`${f.trim()}\``).join('\n')}
              
              ### üéØ Recommendation
              ${recommendation}`;
            }
            
            comment += `
            
            ---
            
            ü§ñ *This preview is automatically generated. The actual release may vary based on additional commits.*
            `;
            
            try {
              // Find existing comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
            
              const existingComment = comments.find(comment => 
                comment.body.includes('Release Preview for PR')
              );
            
              if (existingComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: comment
                });
                console.log('‚úÖ Updated existing PR comment');
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: comment
                });
                console.log('‚úÖ Created new PR comment');
              }
            
              core.setOutput('comment_created', 'true');
            } catch (error) {
              console.log('‚ùå Failed to create/update PR comment:', error.message);
              core.setOutput('comment_created', 'false');
              // Store the comment content for the summary
              core.setOutput('comment_content', comment);
            }

      - name: Set PR status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const shouldRelease = '${{ steps.release_relevance.outputs.should-release }}' === 'true';
            
            let state = 'success';
            let description = 'No release - safe to merge';
            
            if (shouldRelease) {
              const buildSuccess = '${{ steps.build_test.outputs.BUILD_SUCCESS }}' === 'true';
              const lintSuccess = '${{ steps.build_test.outputs.LINT_SUCCESS }}' === 'true';
              const hasIssues = '${{ steps.issue_check.outputs.has_issues }}' === 'true';
              const versionExists = '${{ steps.npm_check.outputs.version_exists }}' === 'true';
              
              description = 'Ready for release';
              
              if (!buildSuccess || !lintSuccess) {
                state = 'failure';
                description = 'Build or lint failures';
              } else if (versionExists) {
                state = 'failure';
                description = 'Version already exists on NPM';
              } else if (hasIssues) {
                state = 'pending';
                description = 'Issues detected - review required';
              }
            }
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: state,
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: description,
              context: 'Release Preview'
            });

      - name: Summary
        run: |
          echo "## üéØ Release Preview Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show release relevance first
          SHOULD_RELEASE="${{ steps.release_relevance.outputs.should-release }}"
          echo "- **Release Relevant:** ${{ steps.release_relevance.outputs.should-release == 'true' && '‚úÖ Yes' || '‚è≠Ô∏è No' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Change Summary:** ${{ steps.release_relevance.outputs.change-summary }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Comment:** ${{ steps.create_comment.outputs.comment_created == 'true' && '‚úÖ Created/Updated' || '‚ùå Failed to create' }}" >> $GITHUB_STEP_SUMMARY
          
          # Only show build/release details if relevant
          if [ "$SHOULD_RELEASE" == "true" ]; then
            echo "- **Current Version:** ${{ steps.release_analysis.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Predicted Version:** ${{ steps.release_analysis.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Version Type:** ${{ steps.release_analysis.outputs.version_type }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Build Status:** ${{ steps.build_test.outputs.BUILD_SUCCESS == 'true' && '‚úÖ Success' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Lint Status:** ${{ steps.build_test.outputs.LINT_SUCCESS == 'true' && '‚úÖ Success' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Issues Detected:** ${{ steps.issue_check.outputs.has_issues == 'true' && '‚ö†Ô∏è Yes' || '‚úÖ None' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **NPM Version Conflict:** ${{ steps.npm_check.outputs.version_exists == 'true' && '‚ùå Yes' || '‚úÖ None' }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # If comment creation failed, show the content in summary
          if [ "${{ steps.create_comment.outputs.comment_created }}" != "true" ]; then
            echo "### üìÑ PR Comment Content (failed to post):" >> $GITHUB_STEP_SUMMARY
            echo '```markdown' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.create_comment.outputs.comment_content }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          # Show recommendation
          if [ "$SHOULD_RELEASE" != "true" ]; then
            echo "### ‚è≠Ô∏è Recommendation: SAFE TO MERGE" >> $GITHUB_STEP_SUMMARY
            echo "Only documentation/config changes, no release will be triggered." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.build_test.outputs.BUILD_SUCCESS }}" != "true" ] || [ "${{ steps.build_test.outputs.LINT_SUCCESS }}" != "true" ]; then
            echo "### ‚ùå Recommendation: DO NOT MERGE" >> $GITHUB_STEP_SUMMARY
            echo "Build or linting failures need to be fixed first." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.npm_check.outputs.version_exists }}" == "true" ]; then
            echo "### ‚ö†Ô∏è Recommendation: INVESTIGATE FIRST" >> $GITHUB_STEP_SUMMARY
            echo "Version conflict needs to be resolved." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.issue_check.outputs.has_issues }}" == "true" ]; then
            echo "### ‚ö†Ô∏è Recommendation: REVIEW REQUIRED" >> $GITHUB_STEP_SUMMARY
            echo "Please address the issues detected." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚úÖ Recommendation: READY TO MERGE" >> $GITHUB_STEP_SUMMARY
            echo "All checks passed successfully!" >> $GITHUB_STEP_SUMMARY
          fi